# 论文阅读与前期工作总结
### 姓名：陈钦德, 陈王勇, 庞海成, 孟印真
### 学号：17343010，17343014, 17343093, 17343087
---
## 前期工作
### 使用示意图展示普通文件IO方式(fwrite等)的流程，即进程与系统内核，磁盘之间的数据交换如何进行？为什么写入完成后要调用fsync？
##### 写文件以fwrite()函数为例，流程如下：
(1)	开始时数据从外部设备输入或自应用层产生，随着IO操作进入IO函数的缓冲区，也即IOBuffer。
(2)	当IOBuffer满或者调用fflush(),fclose()等函数时,调用write()函数把数据写到系统内核的缓存中。
(3)	内核通过判断数据是否dirty来决定是否将数据写入磁盘。如果判断需要写入磁盘，那么将数据送入IO调度队列等候被驱动程序写入磁盘。此时可以调用fsync来确保数据写入磁盘。
(4)	同时这里可以回答题目中的另一个问题，即为什么调用fsync：fsync的功能是确保文件fd所有已修改的内容已经正确同步到硬盘上，该调用会阻塞等待直到设备报告IO完成。

##### 读文件以fread()函数为例，流程如下：
(1)	开始时所请求的数据有可能存在于内核的缓冲区，也有可能存在于磁盘中。如果存在于内核缓冲区中且不是脏数据，直接将数据传递给用户程序。否则内核向下发出IO请求。
(2)	IO调度层接受IO请求并根据调度算法回调驱动层对磁盘发出指令。
(3)	磁盘收到指令后传输数据到内核的缓冲区
(4)	将内核缓冲区中fread()函数调用的数据拷贝到该函数的IOBuffer中。
根据以上流程画出示意图如下：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190422224633974.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMzI2MTk4,size_16,color_FFFFFF,t_70)
 
### 简述文件映射的方式如何操作文件。与普通IO区别？为什么写入完成后要调用msync？文件内容什么时候被载入内存？
+ 简单文件映射使用的函数为mmap，头文件为<sys/mman.h>

+ 这个函数可以将一个磁盘文件映射到进程的虚拟地址空间，实现磁盘文件地址和进程虚拟地址的一一对应关系。这样就可以实现在进程访问这段内虚拟内存时，系统自动将脏页面写到对应的磁盘文件上。
+ 在了解mmap函数操作文件过程之前，我们需要先了解进程中的vm_area_struct结构。
vm_area_struct结构表示一个独立的虚拟内存区域，一个进程中有多个独立的虚拟内存区域，因此进程拥有多个vm_area_struct结构，它们以链表或者树型结构的形式存在。

 mmap函数原型为 void* mmap(void* start,size_t length,int prot,int flags,int fd,off_t offset);
##### 其操作文件的过程如下：
(1)	首先需要在进程的虚拟地址空间中找出一段空闲的足够大小的连续地址
(2)	然后为该连续地址分配一个vm_area_struct结构并根据mmap函数中的参数对该结构进行初始化。
(3)	将该vm_area_struct结构插入到进程维护的相关链表（或树形图）中
(4)	通过参数中的文件描述符找到将要被映射的文件所在的磁盘地址
(5)	通过remap_pfn_range函数实现虚拟地址和磁盘文件地址的一一对应关系。
(6)	进程初次访问时，由于此时并没有数据关联到主存，引发缺页异常。
(7)	将文件读入主存中，此时进程可以对这段内存进行操作。
(8)	若出现脏页面，系统将在一定时间后更新磁盘文件的内容。
如此，mmap完成了一次文件映射过程。

##### 与普通IO的区别在于：
(1)	文件映射使得进程访问文件就像访问普通内存一样，不必再调用read(),write()函数，从而省去系统调用的开销，加快访问速率，提高效率。
(2)	同时文件映射的方式可以通过将同一个文件映射到不同进程的地址空间来实现共享。

修改后的脏页面不会立即更新到磁盘文件上，调用msync()可以实现强制更新。

当进程初次访问文件时，由于此时并没有数据关联到主存，引发缺页异常，然后才会将文件载入内存。

参考Intel的NVM模拟教程模拟NVM环境，用fio等工具测试模拟NVM的性能并与磁盘对比（关键步骤结果截图）。
操作步骤如下：
(1)	根据教程中的内容设置模拟NVM内存区域。由于为虚拟机分配的内存为4G，所以模拟NVM只能在0G到4G分配，由于0~1G可能涉及系统调用，所以保险起见在1G以上分配了模拟区域：
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190422224004203.png)
(2)	随后通过以下操作使设置生效，并重启虚拟机

 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190422224118242.png)
(3)	设置好后内存分区呈现以下情况
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190422224137306.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMzI2MTk4,size_16,color_FFFFFF,t_70)
(4)	通过lsblk命令查看磁盘分区，发现多出一个pmem0
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190422224155781.png)

(5)	通过mount命令将pmem0挂载到一个文件夹上
(6)	分别测试pmem0区和sda1区随机读写的能力，并进行对比
首先是**pmem0随机写能力测试**(请放大查看)：显示的带宽bw为5571MB/s，每秒io次数iops为742818
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190422224301337.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMzI2MTk4,size_16,color_FFFFFF,t_70)
然后是**sda1随机写能力测试**(请放大查看) ，显示的带宽bw为3238KB/s，每秒io次数iops为357
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190422224323988.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMzI2MTk4,size_16,color_FFFFFF,t_70)
接下来进行**pmem0随机读能力测试**，结果如下，显示的带宽bw为157200KB/s，每秒io次数iops为20469
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190422224339625.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMzI2MTk4,size_16,color_FFFFFF,t_70)
**sda1随机读测试**如下，显示的带宽bw为2661KB/s，每秒io次数iops为293
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/2019042222435053.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMzI2MTk4,size_16,color_FFFFFF,t_70)
**可以看出NVM的性能远远高于磁盘的性能。**


### 使用[PMDK的libpmem库](http://pmem.io/pmdk/libpmem/)编写样例程序操作模拟NVM（关键实验结果截图，附上编译命令和简单样例程序）。
（样例程序使用教程的即可，主要工作是编译安装并链接PMDK库）

---
## 论文阅读

### 总结一下本文的主要贡献和观点(500字以内)(不能翻译摘要)。
（回答本文工作的动机背景是什么，做了什么，有什么技术原理，解决了什么问题，其意义是什么）

XXXXXX

### SCM硬件有什么特性？与普通磁盘有什么区别？普通数据库以页的粒度读写磁盘的方式适合操作SCM吗？
XXXXXX
### 操作SCM为什么要调用CLFLUSH等指令？
(写入后不调用，发生系统崩溃有什么后果)
XXXXXX

### FPTree的指纹技术有什么重要作用？
XXXXXX

### 为了保证指纹技术的数学证明成立，哈希函数应如何选取？
（哈希函数生成的哈希值具有什么特征，能简单对键值取模生成吗？）
XXXXXX

### 持久化指针的作用是什么？与课上学到的什么类似？
XXXXXX